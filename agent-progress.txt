# Dray Project Progress Log

## Project Summary
Dray is a Golang implementation of a Kafka v4-compatible streaming system with:
- Leaderless/stateless brokers using object-storage WAL + Oxia metadata
- Stream-table duality with Iceberg integration
- Zone-aware routing for multi-AZ deployments

## Task Breakdown
- Total tasks identified: 130
- Categories: infrastructure (10), metadata (12), storage (12), protocol (25),
  produce (8), fetch (8), topics (6), routing (8), groups (25), compaction (10),
  iceberg (8), gc (6), security (5), observability (12), operations (3), testing (16)

## Recommended Architecture
- Go 1.21+ with modules
- twmb/franz-go for Kafka protocol (kmsg package)
- github.com/oxia-db/oxia for metadata
- AWS SDK v2 for S3-compatible storage
- apache/iceberg-go or parquet-go for Iceberg/Parquet

## Implementation Order
Start with project-setup, then follow spec phases:
1. Phase 0: Foundations (config, logging, metrics, interfaces)
2. Phase 1: Oxia integration (client, CAS, notifications, ephemerals)
3. Phase 2: Object store + WAL format
4. Phase 3: Offset index
5. Phase 4: Kafka protocol + core APIs
6. Phase 5-10: Zone routing, groups, compaction, hardening

## Status
- Planning complete: 2025-12-27
- First working agent should start with "project-setup" task
[2025-12-27T17:30:02.472Z] Completed project-setup: Set up the Go project with repository structure, dependencies, build system, linting, and CI pipeline
[2025-12-27T17:36:29.809Z] Completed config-system: Implement deterministic configuration system with YAML files and environment variable overrides
[2025-12-27T17:43:17.337Z] Completed metrics-skeleton: Create Prometheus metrics skeleton with basic counters and histograms
[2025-12-27T17:45:04.242Z] Completed iceberg-catalog-interface: Define Catalog interface for Iceberg integration with LoadTable, CreateTableIfMissing, AppendDataFiles, GetCurrentSnapshot
[2025-12-27T17:45:33.922Z] Completed object-store-interface: Define ObjectStore interface for S3-compatible storage with PUT, GET range, HEAD, DELETE, multipart
[2025-12-27T17:50:37.242Z] Completed wal-format-encoder: Implement WAL v1 binary format encoder per spec section 5.2.2
[2025-12-27T17:54:55.800Z] Completed metadata-store-interface: Define MetadataStore interface per spec section 6.1 with Get, Put, Delete, List, Txn, Notifications, PutEphemeral
[2025-12-27T18:02:32.163Z] Completed wal-format-decoder: Implement WAL v1 binary format decoder with validation
[2025-12-27T18:02:59.961Z] Completed keyspace-encoders: Implement keyspace helpers with zero-padded numeric keys for lexicographic ordering
[2025-12-27T18:09:11.567Z] Completed wal-roundtrip-test: Verify WAL encode/decode round-trip preserves all data
[2025-12-27T18:12:25.481Z] Completed keyspace-schema: Implement complete Oxia keyspace layout per spec section 6.3
[2025-12-27T18:16:03.704Z] Completed iceberg-rest-catalog-client: Implement Iceberg REST catalog client
[2025-12-27T18:17:13.561Z] Completed metadomain-calculation: Implement MetaDomain hash calculation for streams
[2025-12-27T18:17:41.829Z] Completed wal-fuzz-test: Implement fuzz testing for WAL parser to find edge cases
[2025-12-27T19:38:49.837Z] Completed logging-framework: Implement structured logging with correlationId and traceId propagation
[2025-12-27T19:53:04.247Z] Completed tcp-server: Implement TCP server with Kafka wire protocol framing
[2025-12-27T20:30:54.665Z] Completed zone-id-parsing: Parse zone_id from Kafka client.id per spec 7.1
[2025-12-27T20:35:56.321Z] Completed s3-object-store-adapter: Implement S3-compatible object store adapter with all required operations
[2025-12-27T20:36:56.082Z] Completed kmsg-integration: Integrate twmb/franz-go kmsg package for protocol types
[2025-12-27T22:08:02.898Z] Completed s3-object-store-adapter: Implement S3-compatible object store adapter with all required operations
[2025-12-27T22:32:42.114Z] Completed wal-writer: Implement WAL writer that batches multi-stream entries sorted by streamId
[2025-12-27T22:44:05.421Z] Completed wal-metadomain-isolation: Verify WAL writer enforces MetaDomain isolation - different domains never mix in same WAL
[2025-12-27T22:52:03.179Z] Completed api-versions-handler: Implement ApiVersions (key 18) handler with supported API matrix
[2025-12-27T23:08:30.302Z] Completed produce-buffer: Implement produce buffer with MetaDomain partitioning

[2025-12-27T23:46:17Z] Reviewed oxia-client-wrapper: verified Oxia sync client wrapper, namespace config, notifications, and transactional behavior; fixed range scan draining to avoid goroutine leaks and scoped txn ops to partition key; tests: not run (already run by working agent).
[2025-12-28T00:04:27Z] Reviewed oxia-cas-transactions
- Scope: internal/metadata/oxia/cas_transaction_test.go, internal/metadata/store_test.go
- Verified CAS helpers and expected-version wiring; Oxia store uses ExpectedVersionId/ExpectedRecordNotExists
- Verified Oxia transaction commit maps unexpected versions to ErrTxnConflict per integration tests
- Verified mock Txn applies version checks before commit to ensure atomicity in tests
- Issues found: none
- Tests: not run (already run by working agent)
[2025-12-28T00:11:06Z] Reviewed oxia-notifications
- Scope: internal/metadata/oxia/notifications_test.go, internal/metadata/oxia/notifications.go, internal/metadata/oxia/store.go
- Verified notification stream uses Oxia notifications channel and handles ctx cancel/stream cancel/closed channel
- Verified convertNotification maps create/modify/delete/range-delete to metadata.Notification
- Verified tests cover delivery after Put/delete, restart behavior, and subscription ordering
- Issues found: none
- Tests: not run (already run by working agent)
[2025-12-28T00:20:31Z] Reviewed oxia-embedded-tests
- Scope: internal/metadata/oxia/test_helper.go, internal/metadata/oxia/integration_test.go, internal/metadata/oxia/store.go
- Verified embedded Oxia standalone server helper starts/stops via t.Cleanup and honors OXIA_SERVICE_ADDRESS override
- Verified integration tests now use embedded server and default namespace for isolation
- Verified version mapping between Oxia (0-based) and metadata (1-based) in Get/Put/List/Txn/notifications
- Verified list prefix handling for Oxia path semantics when ending with '/'
- Issues found: none
- Tests: not run (already run by working agent)
[2025-12-28T00:45:45Z] Reviewed oxia-ephemeral-keys
- Scope: internal/metadata/oxia/ephemeral_test.go, internal/metadata/oxia/store.go, internal/metadata/oxia/integration_test.go
- Verified ephemeral Put uses Oxia ephemeral session binding and session timeout configuration
- Verified tests cover session-bound lifecycle, renewal, updates, delete, and closed-store behavior
- Issues found: none
- Tests: not run (already run by working agent)
[2025-12-28T00:54:12Z] Reviewed wal-staging-marker
- Scope: internal/wal/staging.go, internal/wal/staging_test.go
- Verified staging marker JSON fields and key format (/wal/staging/<metaDomain>/<walId>) per spec 9.7
- Verified staging marker written before WAL object and retained on object-store failure
- Verified Flush returns staging key for deletion and DeleteStagingKey helper exists
- Verified MetaDomain enforcement, reset behavior, and chunk offsets ordering
- Issues found: none
- Tests: not run (already run by working agent)
[2025-12-28T00:59:58Z] Reviewed stream-creation
- Scope: internal/index/stream.go, internal/index/stream_test.go, internal/index/doc.go
- Verified CreateStream generates UUID streamId and initializes /streams/<streamId>/hwm to 0
- Verified metadata stored at /dray/v1/streams/<streamId>/meta and retrievable via GetStreamMeta
- Verified CreateStreamWithID detects existing stream via hwm key and preserves atomic transaction usage
- Verified hwm encoding/decoding helpers and error paths for missing/invalid hwm
- Issues found: none
- Tests: not run (already run by working agent)
[2025-12-28T01:06:12Z] Reviewed hwm-maintenance
- Scope: internal/index/stream.go, internal/index/hwm_cache.go, internal/index/hwm_cache_test.go
- Verified GetHWM read path, IncrementHWM/SetHWM use CAS transactions with version checks
- Verified HWM cache reads/writes, invalidates on notifications, and handles close/restart
- Verified notification key parsing for /streams/<id>/hwm
- Issues found: none
- Tests: not run (already run by working agent)
[2025-12-28T01:16:08Z] Reviewed offset-index-append
- Scope: internal/index/entry.go, internal/index/entry_test.go
- Verified AppendIndexEntry reads hwm with version, allocates offset range, builds offset-index key, and writes entry
- Verified transaction updates hwm and index entry atomically in a single Txn
- Verified cumulative size is derived from last index entry and tests cover multi-append sizing
- Verified batchIndex serialization and retrieval in index entries
- Issues found: none
- Tests: not run (already run by working agent)
[2025-12-28T01:24:51Z] Reviewed offset-index-lookup
- Scope: internal/index/entry.go, internal/index/entry_test.go
- Verified LookupOffset uses range list starting at offset+1 to find smallest endOffset > fetchOffset
- Verified HWM handling flags OffsetBeyondHWM and returns HWM for empty or beyond cases
- Verified LookupOffsetWithBounds returns earliest offset from first index entry
- Verified test store List semantics for prefix vs range and added lookup coverage
- Issues found: none
- Tests: not run (already run by working agent)
[2025-12-28T01:48:12Z] Reviewed index-cache
- Scope: internal/index/index_cache.go, internal/index/index_cache_test.go, internal/metadata/mock.go, go.mod
- Verified cache stores index entries with versions and enforces monotonic updates
- Verified notification watcher updates/invalidates entries on delete/update events
- Verified memory and per-stream bounds are enforced via eviction
- Fixed GetEntriesInRange to sort by endOffset and return nil when cache cannot satisfy the fetch offset
- Issues found: range lookup returned unsorted map iteration and could return arbitrary entry ordering
- Tests: not run (already run by working agent)
[2025-12-28T01:54:05Z] Reviewed concurrent-append-test
- Scope: internal/index/entry_test.go
- Verified concurrent append tests cover 2+ writers, monotonic offsets, no overlaps, and total record count
- Verified HWM and index entry counts asserted after concurrent appends
- Verified retries handle version mismatch/txn conflict cases for concurrent writers
- Issues found: none
- Tests: not run (already run by working agent)
